<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>A3</title>
		<script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>
		<script type="text/javascript" src="https://d3js.org/d3-transition.v1.min.js"></script>
		<style type="text/css">
		</style>
	</head>
	<body>
    <button id="btnTotal">Total</button>
    <button id="btnGold">Gold</button>
    <button id="btnSilver">Silver</button>
    <button id="btnBronze">Bronze</button>
    <br/>
  </body>

  <script type="text/javascript">
    // Jaden Ball
    // jjb465
    // Xuan Phuong
    // xtp789
    // CMPT384 Dec 2, 2019

    // globals
    var svg;

    // data structures
    var dataset;
    var medals = {};
    var datalist = [];

    // constants
    var width = 800;
    var height;

    var yRowPos = 30;

    var xTextPos = 10;

    var xRectPos = xTextPos + 50;
    var rectHeight = 11;
    var rectWidth = 200;

    // scaling functions
    var widthScale;

    //Read the data
    d3.csv("Olympic-Data.csv").then(function(data) {
      dataset = data;
      readInData();
    });

    function updateIndexes() {
      for(var i = 0; i < datalist.length; i++) {
        medals[datalist[i].country].index = i;
      }
    }

    // Transitions the labels and stacked bar charts based on index value
    // in the corresponding country object
    function transitionChart() {
      svg.selectAll('text')
        .transition()
        .duration(1000)
        .ease(d3.easeLinear)
        .attr('y', function(d) {
          return (medals[d.country].index + 1) * yRowPos;
        });

      svg.selectAll('rect')
        .transition()
        .duration(1000)
        .ease(d3.easeLinear)
        .attr('y', function(d, i) {
          return (medals[d.country].index + 1) * yRowPos - rectHeight;
        });
    }

    function readInData(){
      // put medal counts in medals object
      dataset.forEach(function(d) {
        if( medals[d.NOC] ){
          medals[d.NOC][d.Medal] += 1;
        } else {
          medals[d.NOC] = {};
          medals[d.NOC]["Gold"] = 0;
          medals[d.NOC]["Silver"] = 0;
          medals[d.NOC]["Bronze"] = 0;
          medals[d.NOC][d.Medal] += 1;
        }
      });

      // create a list of the data for easy sorting
      datalist = Object.keys(medals).map(function(country) {
        return { country, ...medals[country] };
      });

      // sort by total medal count
      datalist.sort(function(a, b) {
        var aVal = a.Gold + a.Silver + a.Bronze;
        var bVal = b.Gold + b.Silver + b.Bronze;
        return d3.descending(aVal, bVal);
      });
      updateIndexes();

      // scale based on medal counts
      widthScale = d3.scaleLinear()
        .domain([
          d3.min(Object.keys(medals), function(d) {
            return medals[d].Gold + medals[d].Silver + medals[d].Bronze;
          }),
          d3.max(Object.keys(medals), function(d) {
            return medals[d].Gold + medals[d].Silver + medals[d].Bronze;
          }),
        ])
        .range([1, rectWidth]);


      //create svg element
      height = (datalist.length * yRowPos) + (2 * yRowPos);
      svg = d3.select("body")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

      generateVisualization();
    }


    // draws the visualization using d3
    function generateVisualization(){

      var labels = svg.selectAll('text').data(datalist);

      // COUNTRY LABELS
      labels
        .enter()
        .append('text')
        .attr('x', xTextPos)
        .attr('y', function(d, i) {
          return (i+1) * yRowPos;
        })
        .style('fill',  'black')
        .text( function (d) {
          return d.country;
        });

      var bars = svg.selectAll('rect').data(datalist);

      // GOLD MEDALS
      bars
        .enter()
        .append('rect')
        .style('fill', 'gold')
        .attr('x', xRectPos)
        .attr('y', function(d, i) {
          return (i+1) * yRowPos - rectHeight;
        })
        .attr('height', rectHeight)
        .attr('width', function(d) {
          return widthScale(d.Gold);
        });

      // SILVER MEDALS
      bars
        .enter()
        .append('rect')
        .style('fill', 'silver')
        .attr('x', function(d) {
          return xRectPos + widthScale(d.Gold);
        })
        .attr('y', function(d, i) {
          return (i+1) * yRowPos - rectHeight;
        })
        .attr('height', rectHeight)
        .attr('width', function(d) {
          return widthScale(d.Silver);
        });

      // BRONZE MEDALS
      bars
        .enter()
        .append('rect')
        .style('fill', '#cd7f32')
        .attr('x', function(d) {
          return xRectPos + widthScale(d.Gold) + widthScale(d.Silver);
        })
        .attr('y', function(d, i) {
          return (i+1) * yRowPos - rectHeight;
        })
        .attr('height', rectHeight)
        .attr('width', function(d) {
          return widthScale(d.Bronze);
        });
    }

    d3.select('#btnGold')
      .on('click', function() {
        // sort by gold medal count
        datalist.sort(function(a, b) {
          var aVal = a.Gold;
          var bVal = b.Gold;
          return d3.descending(aVal, bVal);
        });
        updateIndexes();
        transitionChart();
      });

    d3.select('#btnSilver')
      .on('click', function() {
        // sort by silver medal count
        datalist.sort(function(a, b) {
          var aVal = a.Silver;
          var bVal = b.Silver;
          return d3.descending(aVal, bVal);
        });
        updateIndexes();
        transitionChart();
      });

    d3.select('#btnBronze')
      .on('click', function() {
        // sort by bronze medal count
        datalist.sort(function(a, b) {
          var aVal = a.Bronze;
          var bVal = b.Bronze;
          return d3.descending(aVal, bVal);
        });
        updateIndexes();
        transitionChart();
      });

    d3.select('#btnTotal')
      .on('click', function() {
        // sort by total medal count
        datalist.sort(function(a, b) {
          var aVal = a.Gold + a.Silver + a.Bronze;
          var bVal = b.Gold + b.Silver + b.Bronze;
          return d3.descending(aVal, bVal);
        });
        updateIndexes();
        transitionChart();
      });

  </script>
</html>

